<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Meal Planner</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin:0;
      font-family:Poppins,sans-serif;
      background:linear-gradient(160deg,#1e90ff 0%,#0000cd 100%);
      color:#fff;
    }
    h2 { text-align:center; margin:20px 0 }
    .page { display:none; padding:20px; max-width:960px; margin:0 auto }
    .active { display:block }
    .btn {
      display:block; width:90%; margin:12px auto; padding:14px 18px;
      border:none; border-radius:14px; font-size:18px; font-weight:600;
      cursor:pointer; text-align:center; color:#fff;
    }
    .btn-yellow { background:#ffcc4d; color:#473c00 }
    .btn-green { background:#55d685 }
    .btn-pink { background:#ff7da6 }
    .btn-blue { background:#5aa9ff }
    .inputs { display:grid; gap:10px; margin-bottom:8px }
    .inputs input,.inputs select {
      padding:12px; border-radius:12px; border:2px solid #e6eef2;
      font-size:16px; color:#153243;
    }
    .button-row { display:flex; justify-content:center; gap:16px; margin:12px 0 }
    .card { background:#fff; color:#153243; border-radius:14px; padding:12px; margin:10px 0 }
    .title { font-weight:600; cursor:pointer }
    .recipe { display:none; margin-top:6px; font-style:italic; color:#2a4158 }
    .tool-btn { background:#eee; border:none; border-radius:8px; padding:6px 10px; margin-left:6px; cursor:pointer }
    .shopping-list { background:#fff; color:#153243; border-radius:14px; padding:16px }
    .empty { opacity:.8; font-style:italic }
    .day-label { font-weight:600; margin-right:8px; display:inline-block; width:40px }

    /* ===== Compact 7-day layout so all 7 fit on screen ===== */
    #sevenList {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      align-items: start;
      margin-top: 12px;
    }
    #sevenList .card {
      padding: 10px;
      border-radius: 10px;
      font-size: 14px;
      line-height: 1.15;
      min-height: 64px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    #sevenList .recipe {
      display: block;
      margin-top: 6px;
      font-style: italic;
      color: #2a4158;
      font-size: 12px;
      max-height: 3.6em;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #sevenList .day-label { display: none; }

    @media (max-width: 420px) {
      #sevenList { grid-template-columns: repeat(2, 1fr); gap:8px; }
      #sevenList .card { padding:8px; font-size:13px; min-height:56px; }
      #sevenList .recipe { font-size:11px; max-height:3.2em; }
    }
    @media (min-width: 900px) {
      #sevenList { grid-template-columns: repeat(4, 1fr); }
    }
  </style>
</head>
<body>

<!-- Home Page -->
<div id="home" class="page active">
  <h2>Meal Planner</h2>
  <button class="btn btn-yellow" onclick="nav('planner')">üçΩÔ∏è Meal Planner</button>
  <button class="btn btn-green" onclick="nav('seven')">üìÖ 7 Day Meal Planner</button>
  <button class="btn btn-pink" onclick="nav('shop')">üõí Shopping List</button>
</div>
<!-- Planner Page -->
<div id="planner" class="page">
  <button class="btn btn-green" onclick="nav('home')">üè† Home</button>
  <h2>Meal Planner</h2>
  <div class="inputs">
    <input id="mealName" placeholder="Meal name"/>
    <input id="mealItems" placeholder="Recipe items (comma separated)"/>
    <select id="mealCategory">
      <option>Breakfast</option>
      <option>Lunch</option>
      <option>Dinner</option>
      <option>Snack</option>
    </select>
  </div>
  <div class="button-row">
    <button class="btn btn-blue" onclick="addMeal()">‚ûï Add Meal</button>
    <button class="btn btn-yellow" onclick="nav('seven')">üìÖ 7 Day Meal Planner</button>
  </div>
  <div id="mealList"></div>
</div>
<!-- 7 Day Meal Planner Page -->
<div id="seven" class="page">
  <button class="btn btn-green" onclick="nav('home')">üè† Home</button>
  <h2>7 Day Meal Planner</h2>
  <button class="btn btn-yellow" onclick="shufflePlan()">üîÄ Shuffle Plan</button>
  <button class="btn btn-blue" onclick="nav('manual')">üìù Manually Select Meals</button>
  <div id="sevenList"></div>
  <button id="createListBtn" class="btn btn-pink" style="display:none;" onclick="nav('shop')">
    üõí Create Shopping List
  </button>
</div>

<!-- Manual Selection Page -->
<div id="manual" class="page">
  <button class="btn btn-green" onclick="nav('seven')">‚¨ÖÔ∏è Back to 7 Day Planner</button>
  <h2>Manually Select Meals</h2>
  <div id="manualList"></div>
  <button id="applyManualBtn" class="btn btn-yellow" style="display:none;" onclick="applyManualSelection()">
    ‚úÖ Apply Selected Meals
  </button>
</div>
<!-- Shopping List Page -->
<div id="shop" class="page">
  <button class="btn btn-green" onclick="nav('home')">üè† Home</button>
  <h2>Shopping List</h2>

  <div style="text-align:center; margin-bottom:10px;">
    <button id="exportListBtn" class="btn btn-blue" onclick="exportShoppingList()" style="width:auto; display:inline-block; padding:10px 14px;">
      ‚§ì Export Shopping List
    </button>
  </div>

  <div id="shoppingItems" class="shopping-list"></div>
</div>
<script>
/* ======= App data and initialization ======= */
const defaultMeals = [
  { name:"Spaghetti Bolognese", items:"Pasta, Minced Beef, Tomato Sauce, Garlic, Onion", cat:"Dinner" },
  { name:"Grilled Salmon", items:"Salmon Fillet, Lemon, Olive Oil, Herbs", cat:"Dinner" },
  { name:"Chicken Curry", items:"Chicken, Curry Paste, Coconut Milk, Rice", cat:"Dinner" },
  { name:"Vegetable Stir Fry", items:"Broccoli, Carrots, Peppers, Soy Sauce, Noodles", cat:"Dinner" },
  { name:"Beef Tacos", items:"Taco Shells, Beef, Lettuce, Tomato, Cheese", cat:"Dinner" },
  { name:"Margherita Pizza", items:"Pizza Base, Tomato Sauce, Mozzarella, Basil", cat:"Dinner" },
  { name:"Shepherd's Pie", items:"Minced Lamb, Potatoes, Carrots, Peas, Gravy", cat:"Dinner" }
];

let meals;
try { meals = JSON.parse(localStorage.getItem('meals')); } catch (e) { meals = null; }
if (!Array.isArray(meals) || meals.length === 0) {
  meals = defaultMeals.slice();
  localStorage.setItem('meals', JSON.stringify(meals));
}

let plan;
try { plan = JSON.parse(localStorage.getItem('plan')); } catch (e) { plan = null; }
if (!Array.isArray(plan) || plan.length !== 7) {
  plan = Array(7).fill(null);
  localStorage.setItem('plan', JSON.stringify(plan));
}

let manualSelected = new Set();
let clearedShopping = new Set(JSON.parse(localStorage.getItem('clearedShopping') || '[]'));
let checkedShopping = new Set(JSON.parse(localStorage.getItem('checkedShopping') || '[]'));

function save() {
  localStorage.setItem('meals', JSON.stringify(meals));
  localStorage.setItem('plan',  JSON.stringify(plan));
}
function saveShoppingState() {
  localStorage.setItem('clearedShopping', JSON.stringify(Array.from(clearedShopping)));
  localStorage.setItem('checkedShopping', JSON.stringify(Array.from(checkedShopping)));
}
/* ======= Navigation and helpers ===== */
function nav(p) {
  document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
  const el = document.getElementById(p);
  if (!el) return;
  el.classList.add('active');
  if (p === 'planner') renderMeals();
  if (p === 'seven')   renderPlan();
  if (p === 'shop')    renderShoppingList();
  if (p === 'manual')  renderManualList();
}

function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
function escapeAttr(str) {
  return escapeHtml(str).replace(/"/g, '&quot;');
}

/* ======= Meals management ===== */
function addMeal() {
  const n = document.getElementById('mealName').value.trim();
  const i = document.getElementById('mealItems').value.trim();
  const c = document.getElementById('mealCategory').value;
  if (!n || !i) { alert('Enter meal name and items'); return; }
  meals.push({ name:n, items:i, cat:c });
  save();
  renderMeals();
  document.getElementById('mealName').value = '';
  document.getElementById('mealItems').value = '';
}

function renderMeals() {
  const l = document.getElementById('mealList');
  l.innerHTML = '';
  meals.filter(m => m && m.name && m.items).forEach((m,x) => {
    const d = document.createElement('div');
    d.className = 'card';
    d.innerHTML = `
      <strong onclick="toggleRecipe('r${x}')">${escapeHtml(m.name)}</strong> (${escapeHtml(m.cat)})
      <div id="r${x}" class="recipe">${escapeHtml(m.items)}</div>
      <button class="tool-btn" onclick="editMeal(${x})">‚úèÔ∏è Edit</button>
      <button class="tool-btn" onclick="deleteMeal(${x})">üóëÔ∏è Delete</button>`;
    l.appendChild(d);
  });
}

function toggleRecipe(id) {
  const e = document.getElementById(id);
  if (e) e.style.display = (e.style.display === 'block' ? 'none' : 'block');
}

function editMeal(i) {
  const m = meals[i];
  if (!m) return;
  const n  = prompt("Edit meal name:", m.name);   if (n  === null) return;
  const it = prompt("Edit recipe items:", m.items); if (it === null) return;
  const c  = prompt("Edit category:", m.cat);     if (c  === null) return;

  const newName = n.trim();
  const newItems = it.trim();
  const newCat = c.trim();

  meals[i] = { name:newName, items:newItems, cat:newCat };

  plan = plan.map(p => {
    if (!p) return p;
    if (p.name === m.name && p.items === m.items) {
      return { ...p, name:newName, items:newItems, cat:newCat, locked: !!p.locked };
    }
    return p;
  });

  if (manualSelected.has(m.name)) {
    manualSelected.delete(m.name);
    manualSelected.add(newName);
  }

  save();
  renderMeals();
  renderPlan();
  renderManualList();
}

function deleteMeal(i) {
  const m = meals[i];
  if (!m) return;
  if (!confirm("Delete this meal?")) return;
  meals.splice(i,1);
  plan = plan.map(p => (p && p.name === m.name && p.items === m.items) ? null : p);
  if (manualSelected.has(m.name)) manualSelected.delete(m.name);

  save();
  renderMeals();
  renderPlan();
  renderManualList();

  const createBtn = document.getElementById('createListBtn');
  if (createBtn) createBtn.style.display = (plan.filter(Boolean).length === 7) ? 'block' : 'none';
}
/* ======= Weekly plan: shuffle, compact render, lock ===== */
function shufflePlan() {
  if (!meals.length) { alert('Add some meals first'); return; }

  const lockedEntries = plan.map((p, idx) => (p && p.locked) ? { idx, entry: p } : null).filter(Boolean);
  const lockedKeys = new Set(lockedEntries.map(e => (e.entry.name + '||' + e.entry.items)));
  const pool = meals.filter(m => !lockedKeys.has(m.name + '||' + m.items));

  const shuffled = pool.slice();
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }

  const newPlan = Array(7).fill(null);
  lockedEntries.forEach(e => newPlan[e.idx] = { ...e.entry, locked: true });

  let pIndex = 0;
  for (let i = 0; i < 7; i++) {
    if (newPlan[i]) continue;
    if (pIndex >= shuffled.length) break;
    newPlan[i] = { ...shuffled[pIndex++], locked: false };
  }

  plan = newPlan;
  save();
  renderPlan();
  const createBtn = document.getElementById('createListBtn');
  if (createBtn) createBtn.style.display = (plan.filter(Boolean).length === 7) ? 'block' : 'none';
}

function renderPlan() {
  const l = document.getElementById('sevenList');
  l.innerHTML = '';
  const hasAny = plan.some(p => p && p.name && p.items);

  if (!hasAny) {
    l.innerHTML = '<div class="card empty">No meals in the weekly plan yet. Use Shuffle plan or Manual Select.</div>';
    const createBtn = document.getElementById('createListBtn');
    if (createBtn) createBtn.style.display = 'none';
    return;
  }

  for (let i = 0; i < 7; i++) {
    const m = plan[i];
    const d = document.createElement('div');
    d.className = 'card';

    if (!m) {
      d.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;color:#6b7b88;font-size:13px;">No meal assigned</div>`;
    } else {
      d.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" onchange="toggleLock(${i})" ${m.locked ? 'checked' : ''} title="Lock this meal">
          <div style="flex:1; min-width:0;">
            <div style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              ${escapeHtml(m.name)}
            </div>
            <div style="font-size:12px; color:#3b5566; margin-top:4px;">
              ${escapeHtml(m.cat)}
            </div>
          </div>
        </div>
        <div class="recipe" style="margin-top:8px;">${escapeHtml(m ? m.items : '')}</div>
      `;
    }

    l.appendChild(d);
  }

  const createBtn = document.getElementById('createListBtn');
  if (createBtn) createBtn.style.display = (plan.filter(Boolean).length === 7) ? 'block' : 'none';
}

function toggleLock(i) {
  if (i < 0 || i >= 7) return;
  if (!plan[i]) return;
  plan[i].locked = !plan[i].locked;
  save();
  renderPlan();
}

/* ======= Manual selection page ======= */
function renderManualList() {
  const l = document.getElementById('manualList');
  l.innerHTML = '';
  const validMeals = meals.filter(m => m && m.name && m.items);

  if (validMeals.length === 0) {
    l.innerHTML = '<div class="card empty">No meals added yet. Add some meals first.</div>';
    return;
  }

  validMeals.forEach((m) => {
    const d = document.createElement('div');
    d.className = 'card';
    const checked = manualSelected.has(m.name) ? 'checked' : '';
    d.innerHTML = `
      <label>
        <input type="checkbox" onchange="toggleManual('${escapeAttr(m.name)}')" ${checked}>
        ${escapeHtml(m.name)} (${escapeHtml(m.cat)})
      </label>
      <div class="recipe">${escapeHtml(m.items)}</div>`;
    l.appendChild(d);
  });

  const applyBtn = document.getElementById('applyManualBtn');
  if (applyBtn) applyBtn.style.display = (manualSelected.size === 7) ? 'block' : 'none';
}

function toggleManual(name) {
  if (manualSelected.has(name)) {
    manualSelected.delete(name);
  } else {
    if (manualSelected.size >= 7) {
      alert("You can only select 7 meals.");
      return;
    }
    manualSelected.add(name);
  }
  renderManualList();
}

function applyManualSelection() {
  if (manualSelected.size !== 7) {
    alert("Please select exactly 7 meals.");
    return;
  }
  const selectedMeals = meals.filter(m => manualSelected.has(m.name)).slice(0,7);
  const newPlan = Array(7).fill(null);
  for (let i = 0; i < selectedMeals.length; i++) {
    newPlan[i] = { ...selectedMeals[i], locked: false };
  }
  plan = newPlan;
  save();
  nav('seven');
}

/* ======= Shopping list: dedupe, click-to-check, swipe-to-clear + clear button ======= */
function renderShoppingList() {
  function normalizeItem(raw) {
    if (!raw) return '';
    let s = String(raw).trim().toLowerCase();
    s = s.replace(/[^\w\s]/g, '');
    s = s.replace(/\s+/g, ' ').trim();
    if (s.length > 3 && s.endsWith('s')) s = s.slice(0, -1);
    return s;
  }

  const seen = new Map();
  plan.forEach(m => {
    if (!m || !m.items) return;
    m.items.split(',').map(s => s.trim()).filter(Boolean).forEach(it => {
      const key = normalizeItem(it);
      if (!key) return;
      if (!seen.has(key)) {
        const pretty = it.replace(/\b\w/g, c => c.toUpperCase());
        seen.set(key, pretty);
      }
    });
  });

  const l = document.getElementById('shoppingItems');
  l.innerHTML = '';
  if (seen.size === 0) {
    l.innerHTML = '<div class="card empty">No items yet. Fill your weekly plan first.</div>';
    return;
  }

  const entries = Array.from(seen.entries()).sort((a,b) => a[1].localeCompare(b[1]));

  entries.forEach(([key, pretty], idx) => {
    if (clearedShopping.has(key)) return;

    const d = document.createElement('div');
    d.className = 'shopping-item';
    d.style.display = 'flex';
    d.style.alignItems = 'center';
    d.style.justifyContent = 'space-between';
    d.style.padding = '6px 0';

    const left = document.createElement('div');
    left.style.display = 'flex';
    left.style.alignItems = 'center';
    left.style.gap = '8px';
    left.style.flex = '1';
    left.style.cursor = 'pointer';

    const id = 'shopitem-' + key + '-' + idx;
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.id = id;
    input.style.transform = 'scale(1.05)';
    if (checkedShopping.has(key)) input.checked = true;

    const span = document.createElement('span');
    span.className = 'shop-text';
    span.style.userSelect = 'none';
    span.style.display = 'inline-block';
    span.style.marginLeft = '6px';
    span.textContent = pretty;

    if (checkedShopping.has(key)) {
      span.style.textDecoration = 'line-through';
      span.style.fontWeight = '700';
    } else {
      span.style.textDecoration = 'none';
      span.style.fontWeight = '400';
    }

    left.appendChild(input);
    left.appendChild(span);

    const clearBtn = document.createElement('button');
    clearBtn.className = 'tool-btn';
    clearBtn.title = 'Clear item';
    clearBtn.style.marginLeft = '8px';
    clearBtn.textContent = '‚úñ';

    left.addEventListener('click', (ev) => {
      if (ev.target === clearBtn) return;
      const isChecked = checkedShopping.has(key);
      if (isChecked) {
        checkedShopping.delete(key);
        input.checked = false;
        span.style.textDecoration = 'none';
        span.style.fontWeight = '400';
      } else {
        checkedShopping.add(key);
        input.checked = true;
        span.style.textDecoration = 'line-through';
        span.style.fontWeight = '700';
      }
      saveShoppingState();
    });

    input.addEventListener('change', () => {
      if (input.checked) {
        checkedShopping.add(key);
        span.style.textDecoration = 'line-through';
        span.style.fontWeight = '700';
      } else {
        checkedShopping.delete(key);
        span.style.textDecoration = 'none';
        span.style.fontWeight = '400';
      }
      saveShoppingState();
    });

    clearBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      clearedShopping.add(key);
      if (checkedShopping.has(key)) checkedShopping.delete(key);
      saveShoppingState();
      d.style.transition = 'transform 180ms ease, opacity 180ms ease';
      d.style.transform = 'translateX(-20px)';
      d.style.opacity = '0';
      setTimeout(() => d.remove(), 200);
    });

    let touchStartX = 0;
    let touchStartY = 0;
    let touchMoved = false;

    d.addEventListener('touchstart', (e) => {
      const t = e.changedTouches[0];
      touchStartX = t.clientX;
      touchStartY = t.clientY;
      touchMoved = false;
    }, { passive: true });

    d.addEventListener('touchmove', (e) => {
      touchMoved = true;
    }, { passive: true });

    d.addEventListener('touchend', (e) => {
      if (!touchMoved) return;
      const t = e.changedTouches[0];
      const dx = touchStartX - t.clientX;
      const dy = Math.abs(touchStartY - t.clientY);
      const SWIPE_THRESHOLD = 40;
      const MAX_VERTICAL_DRIFT = 60;
      if (dx > SWIPE_THRESHOLD && dy < MAX_VERTICAL_DRIFT) {
        clearedShopping.add(key);
        if (checkedShopping.has(key)) checkedShopping.delete(key);
        saveShoppingState();
        d.style.transition = 'transform 180ms ease, opacity 180ms ease';
        d.style.transform = 'translateX(-20px)';
        d.style.opacity = '0';
        setTimeout(() => d.remove(), 200);
      }
    }, { passive: true });

    clearBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        clearBtn.click();
      }
    });

    d.appendChild(left);
    d.appendChild(clearBtn);
    l.appendChild(d);
  });
}

/* ======= Export helper ======= */
function exportShoppingList() {
  function normalizeItem(raw) {
    if (!raw) return '';
    let s = String(raw).trim().toLowerCase();
    s = s.replace(/[^\w\s]/g, '');
    s = s.replace(/\s+/g, ' ').trim();
    if (s.length > 3 && s.endsWith('s')) s = s.slice(0, -1);
    return s;
  }

  const items = new Map();
  plan.forEach(m => {
    if (!m || !m.items) return;
    m.items.split(',').map(s => s.trim()).filter(Boolean).forEach(it => {
      const k = normalizeItem(it);
      if (!k) return;
      items.set(k, (items.get(k) || 0) + 1);
    });
  });

  if (items.size === 0) {
    alert('No items to export. Fill your weekly plan first.');
    return;
  }

  const lines = [];
  Array.from(items.keys()).sort().forEach(k => {
    const pretty = k.replace(/\b\w/g, c => c.toUpperCase());
    const count = items.get(k);
    lines.push(`${pretty} ${count > 1 ? `(${count})` : ''}`.trim());
  });

  const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'shopping-list.txt';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ======= Reset helper (kept but no UI) ======= */
function clearAllMeals() {
  if (!confirm('This will remove all custom meals and reset to the default starter meals. Continue?')) return;
  meals = defaultMeals.slice();
  plan = Array(7).fill(null);
  manualSelected = new Set();
  clearedShopping = new Set();
  checkedShopping = new Set();
  save();
  saveShoppingState();
  renderMeals();
  renderPlan();
  renderManualList();
  renderShoppingList();
  const createBtn = document.getElementById('createListBtn');
  if (createBtn) createBtn.style.display = 'none';
  alert('Meals and weekly plan reset to defaults.');
}

/* ======= Service worker registration (non-blocking) ======= */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(reg => { console.info('ServiceWorker registered', reg.scope); })
    .catch(err => { console.warn('ServiceWorker registration failed', err); });
}

/* ======= Init on load ======= */
window.addEventListener('load', () => {
  renderMeals();
  renderPlan();
  renderManualList();
});
</script>
</body>
</html>
